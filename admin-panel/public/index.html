<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueWipe Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .device-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: transform 0.2s;
        }
        .device-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .status-online {
            color: #28a745;
        }
        .status-offline {
            color: #dc3545;
        }
        .status-pending {
            color: #ffc107;
        }
        .job-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .progress-bar-custom {
            height: 20px;
            border-radius: 10px;
        }
        .security-level-badge {
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-center">üî• TrueWipe Advanced Admin Panel</h1>
            <p class="text-center text-muted">Secure Data Destruction System - Enhanced Edition</p>
        </div>

        <!-- Login Form -->
        <div id="loginSection" class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>Login</h4>
                    </div>
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">Login</button>
                        </form>
                        <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboardSection" class="d-none">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>Welcome, <span id="userName"></span></h2>
                        <button id="logoutBtn" class="btn btn-outline-secondary">Logout</button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">Total Devices</h5>
                            <h2 id="totalDevices">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <h5 class="card-title">Online Devices</h5>
                            <h2 id="onlineDevices">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <h5 class="card-title">Active Wipes</h5>
                            <h2 id="activeWipes">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info">
                        <div class="card-body">
                            <h5 class="card-title">Compliance Reports</h5>
                            <h2 id="complianceReports">0</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Devices Section -->
            <div class="row">
                <div class="col-md-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3>Registered Devices</h3>
                        <button id="refreshDevicesBtn" class="btn btn-outline-primary">Refresh</button>
                    </div>
                    <div id="devicesContainer">
                        <!-- Device cards will be loaded here -->
                        <div class="text-center py-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Jobs Section -->
            <div class="row mt-5">
                <div class="col-md-12">
                    <h3>Recent Wipe Jobs</h3>
                    <div id="jobsContainer">
                        <!-- Job cards will be loaded here -->
                        <div class="text-center py-5">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Wipe Confirmation Modal -->
    <div class="modal fade" id="wipeModal" tabindex="-1" aria-labelledby="wipeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="wipeModalLabel">Advanced Data Wipe Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>You are about to initiate a data wipe on device:</p>
                    <p><strong id="wipeDeviceName"></strong></p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Wipe Method</h6>
                            <select id="wipeMethod" class="form-select">
                                <option value="1-pass">1-Pass Overwrite (Fast)</option>
                                <option value="3-pass">3-Pass Overwrite (DoD Standard)</option>
                                <option value="7-pass">7-Pass Overwrite (Enhanced Security)</option>
                                <option value="gutmann">Gutmann Method (35-Pass)</option>
                                <option value="schneier">Schneier Method (7-Pass)</option>
                                <option value="pfitzner">Pfitzner Method (Random Passes)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <h6>Verification Level</h6>
                            <select id="verificationLevel" class="form-select">
                                <option value="quick">Quick Verification</option>
                                <option value="thorough">Thorough Verification</option>
                                <option value="forensic">Forensic Verification</option>
                                <option value="military">Military-Grade Verification</option>
                                <option value="quantum">Quantum-Resistant Verification</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>Security Information</h6>
                        <div id="securityInfo" class="alert alert-info">
                            Selecting higher security options will increase wipe time but provide greater data destruction assurance.
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mt-3">
                        <strong>Warning!</strong> This action will permanently destroy all data on the selected device except the operating system. This process is irreversible.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmWipeBtn">Start Advanced Wipe</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compliance Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel">Compliance Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="reportContent">
                        <!-- Report content will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadReportBtn">Download Report</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Global variables
        let authToken = localStorage.getItem('authToken');
        let currentDeviceId = null;
        let currentJobId = null;
        let socket = io();

        // DOM Elements
        const loginSection = document.getElementById('loginSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
        const devicesContainer = document.getElementById('devicesContainer');
        const jobsContainer = document.getElementById('jobsContainer');
        const wipeModal = new bootstrap.Modal(document.getElementById('wipeModal'));
        const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
        const wipeDeviceName = document.getElementById('wipeDeviceName');
        const wipeMethod = document.getElementById('wipeMethod');
        const verificationLevel = document.getElementById('verificationLevel');
        const confirmWipeBtn = document.getElementById('confirmWipeBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');

        // Check if user is already logged in
        if (authToken) {
            showDashboard();
            loadDashboardData();
        }

        // Login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('username', data.username);
                    showDashboard();
                    loadDashboardData();
                } else {
                    loginError.textContent = data.error;
                    loginError.classList.remove('d-none');
                }
            } catch (error) {
                loginError.textContent = 'An error occurred. Please try again.';
                loginError.classList.remove('d-none');
            }
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            authToken = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('username');
            showLogin();
        });

        // Refresh devices
        refreshDevicesBtn.addEventListener('click', loadDevices);

        // Confirm wipe
        confirmWipeBtn.addEventListener('click', initiateWipe);

        // Download report
        downloadReportBtn.addEventListener('click', downloadReport);

        // Show dashboard
        function showDashboard() {
            loginSection.classList.add('d-none');
            dashboardSection.classList.remove('d-none');
            userName.textContent = localStorage.getItem('username') || 'Admin';
        }

        // Show login
        function showLogin() {
            loginSection.classList.remove('d-none');
            dashboardSection.classList.add('d-none');
            loginForm.reset();
            loginError.classList.add('d-none');
        }

        // Load dashboard data
        async function loadDashboardData() {
            await loadDevices();
            await loadJobs();
        }

        // Load devices
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const devices = await response.json();
                    renderDevices(devices);
                    
                    // Update stats
                    document.getElementById('totalDevices').textContent = devices.length;
                    const onlineCount = devices.filter(d => d.status === 'online').length;
                    document.getElementById('onlineDevices').textContent = onlineCount;
                } else if (response.status === 401) {
                    // Token expired
                    showLogin();
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                devicesContainer.innerHTML = '<div class="alert alert-danger">Error loading devices</div>';
            }
        }

        // Render devices
        function renderDevices(devices) {
            if (devices.length === 0) {
                devicesContainer.innerHTML = '<div class="alert alert-info">No devices registered yet</div>';
                return;
            }
            
            let html = '';
            devices.forEach(device => {
                const statusClass = device.status === 'online' ? 'status-online' : 'status-offline';
                const statusText = device.status === 'online' ? 'Online' : 'Offline';
                
                html += `
                <div class="device-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>${device.name}</h4>
                            <p class="text-muted mb-1">IP: ${device.ip_address}</p>
                            <p class="mb-1"><span class="${statusClass}">‚óè</span> ${statusText}</p>
                            <small class="text-muted">Last seen: ${new Date(device.last_seen).toLocaleString()}</small>
                        </div>
                        <div>
                            ${device.status === 'online' ? 
                                `<button class="btn btn-danger" onclick="showWipeConfirmation('${device.id}', '${device.name}')">Advanced Wipe</button>` : 
                                `<button class="btn btn-secondary" disabled>Device Offline</button>`
                            }
                        </div>
                    </div>
                </div>
                `;
            });
            
            devicesContainer.innerHTML = html;
        }

        // Load jobs
        async function loadJobs() {
            try {
                const response = await fetch('/api/jobs', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const jobs = await response.json();
                    renderJobs(jobs);
                    
                    // Update stats
                    document.getElementById('complianceReports').textContent = jobs.length;
                    const activeCount = jobs.filter(j => j.status === 'in-progress').length;
                    document.getElementById('activeWipes').textContent = activeCount;
                } else if (response.status === 401) {
                    // Token expired
                    showLogin();
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
                jobsContainer.innerHTML = '<div class="alert alert-danger">Error loading jobs</div>';
            }
        }

        // Render jobs
        function renderJobs(jobs) {
            if (jobs.length === 0) {
                jobsContainer.innerHTML = '<div class="alert alert-info">No wipe jobs yet</div>';
                return;
            }
            
            let html = '';
            jobs.slice(0, 5).forEach(job => { // Show only last 5 jobs
                const startTime = job.started_at ? new Date(job.started_at).toLocaleString() : 'Not started';
                const endTime = job.completed_at ? new Date(job.completed_at).toLocaleString() : 'Not completed';
                
                // Parse method and verification level
                const [method, verification] = job.method ? job.method.split('|') : ['Unknown', 'Unknown'];
                
                html += `
                <div class="job-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>Wipe Job for ${job.device_name}</h5>
                            <p class="mb-1">Method: ${method}</p>
                            <p class="mb-1">Verification: ${verification}</p>
                            <p class="mb-1">Status: <span class="badge bg-${getStatusColor(job.status)}">${job.status}</span></p>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">Started: ${startTime}</small><br>
                            <small class="text-muted">Completed: ${endTime}</small><br>
                            ${job.status === 'completed' ? 
                                `<button class="btn btn-sm btn-outline-primary mt-2" onclick="showReport('${job.id}')">View Report</button>` : 
                                ''
                            }
                        </div>
                    </div>
                    ${job.result ? `<div class="mt-2"><small>Result: ${JSON.parse(job.result).message || 'N/A'}</small></div>` : ''}
                </div>
                `;
            });
            
            jobsContainer.innerHTML = html;
        }

        // Get status badge color
        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'success';
                case 'failed': return 'danger';
                case 'in-progress': return 'warning';
                case 'pending': return 'info';
                default: return 'secondary';
            }
        }

        // Show wipe confirmation
        function showWipeConfirmation(deviceId, deviceName) {
            currentDeviceId = deviceId;
            wipeDeviceName.textContent = deviceName;
            wipeModal.show();
        }

        // Initiate wipe
        async function initiateWipe() {
            try {
                const method = wipeMethod.value;
                const verification = verificationLevel.value;
                
                const response = await fetch(`/api/devices/${currentDeviceId}/wipe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ method, verificationLevel: verification })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentJobId = data.jobId;
                    alert(`Advanced wipe command sent successfully. Job ID: ${data.jobId}`);
                    wipeModal.hide();
                    loadDashboardData(); // Refresh data
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error initiating wipe:', error);
                alert('An error occurred while sending the wipe command.');
            }
        }

        // Show compliance report
        async function showReport(jobId) {
            try {
                const response = await fetch(`/api/reports/${jobId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const report = await response.json();
                    renderReport(report);
                    reportModal.show();
                } else {
                    alert('Error loading report');
                }
            } catch (error) {
                console.error('Error loading report:', error);
                alert('An error occurred while loading the report.');
            }
        }

        // Render compliance report
        function renderReport(report) {
            const content = document.getElementById('reportContent');
            
            content.innerHTML = `
                <h5>Compliance Report #${report.jobId}</h5>
                <table class="table table-bordered">
                    <tr>
                        <th>Device ID</th>
                        <td>${report.deviceId}</td>
                    </tr>
                    <tr>
                        <th>Wipe Method</th>
                        <td>${report.method}</td>
                    </tr>
                    <tr>
                        <th>Verification Level</th>
                        <td>${report.verificationLevel}</td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td><span class="badge bg-${getStatusColor(report.status)}">${report.status}</span></td>
                    </tr>
                    <tr>
                        <th>Started</th>
                        <td>${report.startedAt ? new Date(report.startedAt).toLocaleString() : 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Completed</th>
                        <td>${report.completedAt ? new Date(report.completedAt).toLocaleString() : 'N/A'}</td>
                    </tr>
                    ${report.result ? `
                    <tr>
                        <th>Confidence Level</th>
                        <td>${(report.result.confidence * 100).toFixed(3)}%</td>
                    </tr>
                    <tr>
                        <th>Certification ID</th>
                        <td>${report.result.report?.certification || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Compliance Standards</th>
                        <td>${report.result.report?.standards?.join(', ') || 'N/A'}</td>
                    </tr>
                    ` : ''}
                </table>
                ${report.result ? `<p><strong>Result:</strong> ${report.result.message}</p>` : ''}
            `;
        }

        // Download report
        function downloadReport() {
            // In a real implementation, this would download a PDF or other format
            alert('In a full implementation, this would download a compliance report PDF.');
        }

        // Make functions available globally
        window.showWipeConfirmation = showWipeConfirmation;
        window.showReport = showReport;
    </script>
</body>
</html>